name: Deploy to aaPanel

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "üöÄ B·∫Øt ƒë·∫ßu qu√° tr√¨nh Deploy..."
            
            # 0. S·ª≠a l·ªói "dubious ownership" (Do th∆∞ m·ª•c thu·ªôc user www nh∆∞ng ssh v√†o b·∫±ng root)
            git config --global --add safe.directory /www/wwwroot/vote-yep.allship.vn
            
            # 1. Di chuy·ªÉn v√†o th∆∞ m·ª•c web
            cd /www/wwwroot/vote-yep.allship.vn
            
            # 2. Lo·∫°i b·ªè c√°c thay ƒë·ªïi t·∫°m th·ªùi tr√™n server (n·∫øu c√≥) ƒë·ªÉ tr√°nh conflict
            git fetch origin main
            git reset --hard origin/main
            
            # 3. K√©o code m·ªõi nh·∫•t t·ª´ GitHub
            git pull origin main
            
            # 4. Ph√¢n l·∫°i quy·ªÅn ƒë·ªÉ Web Server (user www) c√≥ th·ªÉ ƒë·ªçc ghi file
            chown -R www:www .
            chmod -R 755 .
            
            echo "‚úÖ Deploy th√†nh c√¥ng!"
